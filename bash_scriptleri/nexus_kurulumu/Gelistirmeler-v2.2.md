# Nexus Repository Manager Kurulum Scripti v2.2 - GeliÅŸtirmeler

## Ã–zet
Bu versiyon (v2.2), Ã¶nceki v2.1 versiyonunun tÃ¼m Ã¶zelliklerini koruyarak, aÅŸaÄŸÄ±daki kritik geliÅŸtirmeleri iÃ§ermektedir.

---

## ğŸ†• YapÄ±lan GeliÅŸtirmeler

### 1. âœ… Custom-Key.json DosyasÄ± DesteÄŸi

**Ã–nceki Durum (v2.1):**
- `custom-encryption.json` dosyasÄ± kullanÄ±lÄ±yordu
- KarmaÅŸÄ±k JSON yapÄ±sÄ± (fixedEncryption, salt, iv iÃ§eriyordu)

**Yeni Durum (v2.2):**
- BasitleÅŸtirilmiÅŸ `custom-key.json` dosyasÄ± kullanÄ±lÄ±yor
- Daha temiz ve anlaÅŸÄ±lÄ±r yapÄ±:

```json
{
  "active": "alibaba33442",
  "keys": [
    {
      "id": "alibaba33442",
      "key": "d2lsbGluZ3BsYW5lc3RvcnlncmFiYmVkaGVscGZ1bGM="
    }
  ]
}
```

**Dosya Konumu:** `/app/nexus/etc/custom-key.json`

**GÃ¼venlik:**
- Ä°zinler: `600` (sadece nexus kullanÄ±cÄ±sÄ± okuyabilir)
- Sahiplik: `nexus:nexus`

---

### 2. âœ… nexus.secrets.file Property'si Eklendi

**Ã–nceki Durum (v2.1):**
- `nexus.security.customEncryptionFile` kullanÄ±lÄ±yordu

**Yeni Durum (v2.2):**
- Modern `nexus.secrets.file` property'si kullanÄ±lÄ±yor
- `default-application.properties` iÃ§eriÄŸi:

```properties
# Nexus Repository Manager Configuration
# Auto-generated by installation script v2.2

# Logging Configuration
logging.config=./etc/logback/logback.xml

# Custom Secrets File Configuration
secret.nexusSecret.enabled=true
nexus.secrets.file=/app/nexus/etc/custom-key.json
```

**Ã–nemli:**
- TÄ±rnak iÅŸareti kullanÄ±lmÄ±yor
- Inline `nexus.security.encryptionKey` tanÄ±mÄ± yok
- Temiz ve standart property formatÄ±

---

### 3. âœ… Otomatik API Re-encryption Ã‡aÄŸrÄ±sÄ±

**Yeni Ã–zellik:**
Kurulum tamamlandÄ±ktan 90 saniye sonra otomatik olarak aÅŸaÄŸÄ±daki API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±r:

```bash
curl -X 'PUT' \
  'https://nexus.lab.akyuz.tech/service/rest/v1/secrets/encryption/re-encrypt' \
  -u 'admin:INITIAL_PASSWORD' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -H 'NX-ANTI-CSRF-TOKEN: 0.6199265331343733' \
  -H 'X-Nexus-UI: true' \
  -d '{
  "secretKeyId": "alibaba33442",
  "notifyEmail": "string"
}'
```

**Ã–zellikler:**
- 90 saniye geri sayÄ±m ile bekler
- SSL etkin ise `https://domain` kullanÄ±r
- DeÄŸilse `http://localhost:8081` kullanÄ±r
- Ä°lk admin ÅŸifresini otomatik okur
- BaÅŸarÄ±/baÅŸarÄ±sÄ±zlÄ±k durumunu raporlar
- BaÅŸarÄ±sÄ±z olursa manuel komut Ã¶nerir

**Fonksiyon:** `trigger_api_reencryption()`

---

### 4. âœ… Systemd Service Ä°yileÅŸtirmesi

**Problem:**
`systemctl stop nexus` komutu Ã§alÄ±ÅŸÄ±yordu ancak durum kontrolÃ¼nde hata gÃ¶rÃ¼nÃ¼yordu:

```
Ã— nexus.service - Nexus Repository Manager
     Active: failed (Result: exit-code) since Wed 2025-11-19 16:49:22 +03
   Main PID: 1428 (code=exited, status=143)
```

**Ã‡Ã¶zÃ¼m:**
Systemd service dosyasÄ±na `SuccessExitStatus=143` satÄ±rÄ± eklendi:

```ini
[Unit]
Description=Nexus Repository Manager
After=network.target

[Service]
Type=forking
LimitNOFILE=65536
Environment="NEXUS_HOME=/app/nexus"
Environment="NEXUS_DATA=/app/data/nexus/sonatype-work/nexus3"
Environment="HOME=/app/data/nexus/sonatype-work/nexus3"
Environment="JAVA_TOOL_OPTIONS=-Duser.home=/app/data/nexus/sonatype-work/nexus3"
Environment="INSTALL4J_ADD_VM_PARAMS=-Dkaraf.data=/app/data/nexus/sonatype-work/nexus3 -Dkaraf.home=/app/nexus -Dkaraf.base=/app/nexus -Djava.io.tmpdir=/app/data/nexus/sonatype-work/nexus3/tmp"
ExecStart=/app/nexus/bin/nexus start
ExecStop=/app/nexus/bin/nexus stop
User=nexus
Restart=on-abort
SuccessExitStatus=143

[Install]
WantedBy=multi-user.target
```

**AÃ§Ä±klama:**
- Exit code 143 = SIGTERM (normal kapatma sinyali)
- Systemd artÄ±k bunu baÅŸarÄ±lÄ± sayacak
- `systemctl status nexus` artÄ±k "failed" gÃ¶stermeyecek

---

## ğŸ“‹ Korunan Ã–zellikler (v2.1'den)

AÅŸaÄŸÄ±daki tÃ¼m Ã¶zellikler **aynen korunmuÅŸtur**:

âœ… Otomatik custom encryption key oluÅŸturma  
âœ… "Default Secret Encryption Key" uyarÄ±sÄ±nÄ± baÅŸtan Ã¶nleme  
âœ… DetaylÄ± gÃ¼venlik loglamasÄ±  
âœ… Encryption key backup'Ä± otomatik oluÅŸturma  
âœ… Kurulum sonrasÄ± doÄŸrulama testleri  
âœ… GeliÅŸtirilmiÅŸ tÄ±rnak kontrolÃ¼  
âœ… SSL/HTTPS desteÄŸi (--enable-ssl)  
âœ… Let's Encrypt entegrasyonu  
âœ… Self-signed sertifika desteÄŸi  
âœ… Verbose mode (--verbose)  
âœ… Disk alanÄ± kontrolleri  
âœ… Firewall yapÄ±landÄ±rmasÄ±  
âœ… Java 17 kurulumu  
âœ… RHEL 9 tabanlÄ± sistem kontrolÃ¼  

---

## ğŸš€ KullanÄ±m

### Basit Kurulum (HTTP):
```bash
chmod +x install-nexus-v2_2-enhanced.sh
sudo ./install-nexus-v2_2-enhanced.sh
```

### SSL ile Kurulum (Let's Encrypt):
```bash
sudo ./install-nexus-v2_2-enhanced.sh \
  --enable-ssl \
  --domain nexus.lab.akyuz.tech \
  --email admin@akyuz.tech
```

### SSL ile Kurulum (Self-Signed):
```bash
sudo ./install-nexus-v2_2-enhanced.sh \
  --enable-ssl \
  --domain nexus.lab.akyuz.tech \
  --self-signed
```

### Verbose Mode:
```bash
sudo ./install-nexus-v2_2-enhanced.sh --verbose
```

---

## âœ… DoÄŸrulama

### 1. Custom Key KontrolÃ¼
```bash
# Dosya mevcut mu?
ls -la /app/nexus/etc/custom-key.json

# Ä°Ã§eriÄŸi gÃ¶rÃ¼ntÃ¼le
cat /app/nexus/etc/custom-key.json

# JSON formatÄ± geÃ§erli mi?
python3 -m json.tool /app/nexus/etc/custom-key.json
```

### 2. Properties KontrolÃ¼
```bash
# nexus.secrets.file tanÄ±mÄ± var mÄ±?
grep "nexus.secrets.file" /app/nexus/etc/default-application.properties

# Ä°Ã§eriÄŸi gÃ¶rÃ¼ntÃ¼le
cat /app/nexus/etc/default-application.properties
```

### 3. Servis Durumu KontrolÃ¼
```bash
# Servis Ã§alÄ±ÅŸÄ±yor mu?
systemctl status nexus

# ArtÄ±k "failed" gÃ¶stermemeli!
# Stop testi:
systemctl stop nexus
systemctl status nexus  # "inactive (dead)" gÃ¶rmeli, "failed" deÄŸil
systemctl start nexus
```

### 4. API Re-encryption KontrolÃ¼
```bash
# Nexus loglarÄ±nÄ± kontrol et
tail -f /app/data/nexus/sonatype-work/nexus3/log/nexus.log

# API Ã§aÄŸrÄ±sÄ±nÄ±n baÅŸarÄ±lÄ± olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rÃ¼n
```

### 5. Web ArayÃ¼zÃ¼ KontrolÃ¼
```bash
# Ä°lk admin ÅŸifresini al
cat /app/data/nexus/sonatype-work/nexus3/admin.password

# Web arayÃ¼zÃ¼ne gir:
# http://YOUR_IP:8081
# veya
# https://nexus.lab.akyuz.tech

# Support â†’ Status sayfasÄ±nÄ± kontrol et
# "Default Secret Encryption Key" uyarÄ±sÄ± OLMAMALI!
```

---

## ğŸ“ Ã–nemli Dosyalar

| Dosya | Konum | AÃ§Ä±klama |
|-------|-------|----------|
| Custom Key | `/app/nexus/etc/custom-key.json` | Åifreleme anahtarÄ± |
| Properties | `/app/nexus/etc/default-application.properties` | Nexus yapÄ±landÄ±rmasÄ± |
| Backup | `/root/nexus-encryption-key-TARIH.txt` | Key backup dosyasÄ± |
| Service | `/etc/systemd/system/nexus.service` | Systemd service dosyasÄ± |
| Log | `/var/log/nexus-installation-TARIH.log` | Kurulum log dosyasÄ± |

---

## âš ï¸ Ã–nemli Notlar

1. **Backup DosyasÄ±nÄ± GÃ¼venli Yere KopyalayÄ±n!**
   ```bash
   cp /root/nexus-encryption-key-*.txt /gÃ¼venli/yer/
   ```

2. **Ä°lk GiriÅŸte Admin Åifresini DeÄŸiÅŸtirin**
   ```bash
   cat /app/data/nexus/sonatype-work/nexus3/admin.password
   ```

3. **API Re-encryption Manuel Tekrar Ã‡alÄ±ÅŸtÄ±rma**
   EÄŸer otomatik API Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z olduysa:
   ```bash
   ADMIN_PASS=$(cat /app/data/nexus/sonatype-work/nexus3/admin.password)
   
   curl -X 'PUT' \
     'http://localhost:8081/service/rest/v1/secrets/encryption/re-encrypt' \
     -u "admin:${ADMIN_PASS}" \
     -H 'accept: application/json' \
     -H 'Content-Type: application/json' \
     -H 'NX-ANTI-CSRF-TOKEN: 0.6199265331343733' \
     -H 'X-Nexus-UI: true' \
     -d '{
     "secretKeyId": "alibaba33442",
     "notifyEmail": "string"
   }'
   ```

4. **Systemd Stop Testi**
   ```bash
   # ArtÄ±k hata vermemeli
   systemctl stop nexus
   systemctl status nexus
   ```

---

## ğŸ”„ Versiyon GeÃ§miÅŸi

### v2.2 (2025-11-19)
- âœ… custom-key.json basitleÅŸtirilmiÅŸ format
- âœ… nexus.secrets.file property desteÄŸi
- âœ… Otomatik API re-encryption
- âœ… Systemd SuccessExitStatus=143 dÃ¼zeltmesi
- âœ… TÃ¼m v2.1 Ã¶zellikleri korundu

### v2.1
- Custom encryption key desteÄŸi
- Default key uyarÄ±sÄ±nÄ± Ã¶nleme
- TÄ±rnak kontrolÃ¼ dÃ¼zeltmesi

---

## ğŸ“ Destek

Script ile ilgili sorularÄ±nÄ±z iÃ§in:
- Log dosyasÄ±nÄ± kontrol edin: `/var/log/nexus-installation-*.log`
- Nexus loglarÄ±nÄ± kontrol edin: `/app/data/nexus/sonatype-work/nexus3/log/nexus.log`
- Systemd loglarÄ±nÄ± kontrol edin: `journalctl -u nexus -f`

---

## ğŸ“„ Lisans

Bu script Nexus Repository Manager kurulumu iÃ§in hazÄ±rlanmÄ±ÅŸ bir yardÄ±mcÄ± araÃ§tÄ±r.
Nexus Repository Manager, Sonatype tarafÄ±ndan geliÅŸtirilmektedir.

---

**Son GÃ¼ncelleme:** 19 KasÄ±m 2025  
**Script Versiyonu:** 2.2  
**Nexus Versiyonu:** 3.86.2-01
